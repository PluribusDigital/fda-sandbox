machine:
  python:
    version: 3.4.2
  services:
    - docker

dependencies:
  pre:
    # install aws command line tools for elasticbean stalk deployment
    - pip install awscli
    # nodejs-legacy fails, why do we need this?
    # - sudo apt-get install nodejs-legacy
    # python setup
    - cd gruve && python setup.py develop

  post:
    - bundle exec rake bower:install
    - if [ "$BUILD_POSTGRES_IMAGE" = "true"  ]; then bash docker_build.sh $CIRCLE_SHA1 $POSTGRES_USER $POSTGRES_PASSWORD; fi:
        timeout:1800

# skipping seed temporarily
#database:
#  post:
#    - bundle exec rake db:seed:
#        environment:
#          RAILS_ENV: test
#          RACK_ENV: test

test:
  override:
    - echo "skipping tests temporarily"
    #- bundle exec rspec:
    #    environment:
    #      RAILS_ENV: test
    #      RACK_ENV: test

deployment:
#  demo:
#    branch: master
#    commands:
#      - bundle exec cap demo deploy
  elasticbeanstalk:
    branch: master
    commands:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASSWORD
    - bash docker_deploy.sh $CIRCLE_SHA1 $POSTGRES_USER $POSTGRES_PASSWORD $BUILD_POSTGRES_IMAGE